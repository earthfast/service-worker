<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" href="/earthfast/styles/main.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EarthFast Loading</title>
</head>

<body class="hidden regular-flow">
  <div id="content">
    <div class="logo">
      <img id="logo" class="logo__image" src="/earthfast/images/earth-fast-logo.svg" alt="Earth Fast">
      <h2 class="logo__title">EarthFast 2133</h2>
    </div>
    <div class="description-container">
      <div class="description-text">
        <span class="securely-text" id="description-text">Securely loading</span>
        <span id="domain"></span>
      </div>
      <div id="spinner" class="spinner"></div>
    </div>

    <!-- Developer Tools Notice -->
    <div id="dev-tools-notice" class="dev-tools-notice">
      <p>Please open Developer Tools (F12) and go to the Network tab before continuing.</p>
      <p>Once you have the Network tab open, click the button below:</p>
      <button id="start-loading-button">Start Loading</button>
    </div>

    <!-- Developer Tools Instructions (only visible when the notice is not active) -->
    <div class="dev-tools-instructions">
      <p class="help-text text-center">To follow along with the loading process, open your browser's developer tools
        (F12) and go to
        the Network tab.</p>
    </div>

    <!-- New container for stages -->
    <div class="stages-container" id="stages-container">
      <!-- Stage 1: Manifest Loading -->
      <div class="stage" id="stage-manifest">
        <div class="stage-header stage-toggle-header">
          <div class="stage-icon pending" id="stage-manifest-icon">
            <span>1</span>
          </div>
          <div class="stage-title">Asset Manifest Consensus</div>
          <div class="stage-progress" id="stage-manifest-progress">
            <div class="stage-progress-text">0/0 nodes</div>
          </div>
          <div class="stage-spinner"></div>
          <div class="stage-time" id="stage-manifest-time"></div>
          <div class="stage-toggle">▼</div>
        </div>
        <div class="stage-content">
          <div id="stage-manifest-content">
            <p>Waiting for asset manifest consensus from content nodes...</p>
            <p class="help-text">Tip: Search for "earthfast.json" in the Network panel to see manifest responses from
              each node.</p>
            <ul class="manifest-list" id="manifest-nodes-list">
              <!-- Manifest nodes will be loaded dynamically -->
            </ul>
          </div>
        </div>
      </div>

      <!-- Stage 2: index.html loaded -->
      <div class="stage" id="stage-index">
        <div class="stage-header stage-toggle-header">
          <div class="stage-icon pending" id="stage-index-icon">
            <span>2</span>
          </div>
          <div class="stage-title">index.html Loaded</div>
          <div class="stage-spinner"></div>
          <div class="stage-time" id="stage-index-time"></div>
          <div class="stage-toggle">▼</div>
        </div>
        <div class="stage-content">
          <div id="stage-index-content">
            <p>Loading index.html from content nodes...</p>
            <p class="help-text">Tip: Search for "index.html" in the Network panel to see the page load.</p>
          </div>
        </div>
      </div>

      <!-- Stage 3: Request Table -->
      <div class="stage" id="stage-resources">
        <div class="stage-header stage-toggle-header">
          <div class="stage-icon pending" id="stage-resources-icon">
            <span>3</span>
          </div>
          <div class="stage-title">Network Requests</div>
          <div class="stage-spinner"></div>
          <div class="stage-time" id="stage-resources-time"></div>
          <div class="stage-toggle">▼</div>
        </div>
        <div class="stage-content">
          <div id="stage-resources-content">
            <p>Loading website resources from content nodes...</p>
            <p class="help-text">Tip: Use these filters in the Network panel to see different types of requests:</p>
            <ul class="filter-list">
              <li><span class="filter-type">CSS:</span> <code class="filter-code">*.css</code></li>
              <li><span class="filter-type">JavaScript:</span> <code class="filter-code">*.js</code></li>
              <li><span class="filter-type">Images:</span> <code class="filter-code">*.svg, *.png, *.jpg</code></li>
            </ul>
            <div class="table-container">
              <table class="requests-table" id="requests-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Time</th>
                    <th>Resource</th>
                    <th>Node</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="requests-table-body">
                  <!-- Requests will be loaded dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Stage 4: Site Ready -->
      <div class="stage" id="stage-ready">
        <div class="stage-header stage-toggle-header">
          <div class="stage-icon pending" id="stage-ready-icon">
            <span>4</span>
          </div>
          <div class="stage-title">Website Ready</div>
          <div class="stage-spinner"></div>
          <div class="stage-time" id="stage-ready-time"></div>
          <div class="stage-toggle">▼</div>
        </div>
        <div class="stage-content">
          <div id="stage-ready-content">
            <div id="stage-ready-message"></div>
            <button id="stage-ready-button" class="continue-button">Continue to website</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load Core JavaScript -->
  <script src="/earthfast/scripts/earth-fast-core.js"></script>

  <!-- Initialization Script -->
  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const isSecureViewer = urlParams.has('secure_viewer');

    // Function to load the secure viewer script if needed
    function loadSecureViewerScript() {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = '/earthfast/scripts/secure-viewer.js';
        script.async = true;
        script.onload = () => {
          // Initialize the secure viewer functionality
          if (window.EarthFastSecureViewer) {
            // First initialize the core with secure viewer flag to properly set up DOM
            EarthFast.init(true);
            // Then apply secure viewer enhancements to core module
            window.EarthFastSecureViewer.enhanceRequestTracker();
            // Finally initialize secure viewer mode
            window.EarthFastSecureViewer.initSecureViewer();
            resolve();
          } else {
            reject(new Error('Secure viewer script loaded but module not found'));
          }
        };
        script.onerror = () => {
          reject(new Error('Failed to load secure viewer script'));
        };
        document.body.appendChild(script);
      });
    }

    // Start the application when the DOM is loaded
    window.addEventListener('load', () => {
      if (isSecureViewer) {
        // Load the secure viewer script and initialize
        loadSecureViewerScript()
          .catch(error => {
            console.error('Error loading secure viewer:', error);
            // Fallback to normal mode if secure viewer fails to load
            EarthFast.init(false);
          });
      } else {
        // Initialize normal mode directly
        EarthFast.init(false);
      }
    });
  </script>
</body>

</html>
