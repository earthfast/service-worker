<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" href="/earthfast/styles/main.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <div id="content">
    <div class="logo">
      <img id="logo" class="logo__image" src="/earthfast/images/earth-fast-logo.svg" alt="Earth Fast">
      <h2 class="logo__title">EarthFast</h2>
    </div>
    <div class="description-container">
      <div class="description-text">
        <span class="securely-text" id="description-text">Securely loading</span>
        <span id="domain"></span>
      </div>
      <div id="spinner" class="spinner"></div>
    </div>
    <!-- <p id="error"></p> -->
  </div>

  <script>
    const serviceWorker = '/earthfast-sw.js';

    function fail(message) {
      console.error(message);
      // document.getElementById('error').innerText = message;
      document.getElementById('spinner').classList.add('hidden');
      document.getElementById('description-text').innerHTML = '<span style="color: #FF4D4D; margin-right: 5px;">&#x2716;</span>Failed to load';
    }

    const reloadAfterWallTime = function (initDate) {
      return function (delayMs) {
        const msSinceInit = Date.now() - initDate;
        const timeout = Math.max(0, delayMs - msSinceInit);
        setTimeout(() => location.reload(), timeout);
      }
    }(Date.now());

    window.addEventListener('load', () => {
      document.getElementById('domain').innerText = location.host;

      // lack of service worker support is a catastrophic failure
      if (!('serviceWorker' in navigator)) {
        fail('This browser does not support the Armada Network Service Worker, please use a native browser instead.');
        return;
      }

      // listen for messages from the service worker
      navigator.serviceWorker.addEventListener('message', event => {
        const eventType = event.data.type ? event.data.type : event.data.action;
        console.log(`New service worker message received '${eventType}'`, event);

        switch (eventType) {
          // service worker is initialized
          case 'INITIALIZED': reloadAfterWallTime(1000); break;

          // a new service worker version has been detected
          case 'VERSION_DETECTED': console.log('VERSION_DETECTED'); break;

          // a new service worker version is ready to be applied
          case 'VERSION_READY': console.log('VERSION_READY'); break;

          // the content checksum from the manifest doesn't match the hash of the fetched content
          case 'CONTENT_CHECKSUM_MISMATCH': console.log('CONTENT_CHECKSUM_MISMATCH'); break;

          // a single content node failed to retrieve content
          case 'CONTENT_NODE_FETCH_FAILURE': console.log('CONTENT_NODE_FETCH_FAILURE'); break;

          // all available content nodes failed to retrieve content
          case 'CONTENT_NODES_FETCH_FAILURE': console.log('CONTENT_NODES_FETCH_FAILURE'); break;
        }
      });

      navigator.serviceWorker.register(serviceWorker, { scope: '/' })
        .then(reg => {
          if (reg.installing) {
            console.log('Service worker installing');
            reg.installing.addEventListener('statechange', () => {
              if (reg.installing.state === 'installed') {
                console.log('Service worker installed, reloading...');
                window.location.reload();
              }
            });
          } else if (reg.waiting) {
            console.log('Service worker waiting');
            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          } else if (reg.active) {
            console.log('Service worker active');
            window.location.reload();
          }

          navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('New service worker controlling, reloading...');
            window.location.reload();
          });
        })
        .catch(err => {
          fail('Service worker registration failed: ' + err);
        });
    });
  </script>
</body>

</html>